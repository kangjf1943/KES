---
title: "Pattern of urban forest ecosystem services across land use and onsite land cover"
author: "Jiefeng Kang, Satoshi Hirabayashi, Shozo Shibata"
output:
  bookdown::word_document2: default
bibliography: My Library.bib
csl: In_forests.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo=FALSE, warning=FALSE, results="hide", error=TRUE, message = FALSE)
```
**Key words: **
urban; ecosystem services; land use; land cover; green infrastructure

# Abstract {-}

The demand for urban ecosystem services increases with the rapid growth of urban population.
Urban forest is a crucial ecosystem provider in cities. 
To achieve a better estimation of urban ecosystem services, the understanding of the link between heterogeneity and ecosystem services within cities is needed. 
And other than street trees and forest remnant, the contribution of dispersed green space should also be taken into account. 
In this study, a ground-based sample quadrat investigation of trees across a sequence of land types in Kyoto City was applied. 
Tree values and ecosystem services was further calculated using a customized i-Tree Eco tool. 
The ecosystem services calculated includes carbon storage and sequestration, air pollutants removal, and runoff reduction. 
Ecosystem services of different land types were compared at both quadrat and single-tree level. 
We found no significant difference across land use for all the ecosystem services at quadrat level. 
However, ecosystem services are different across both land use and onsite land cover classes at single-tree level; the interaction effect of land use and onsite land cover is also found significant. 
We performed a species-specific analysis and found that the pattern of ecosystem services across land types varies with both the service tested and species. 
Our results of the comparison of ecosystem service across land types indicate the heterogeneity within a city should be considered when estimating urban ecosystem services. 

# Introduction {-}

<!-- ES in urban -->
The world’s urban population is expected to increase from 55.71% in 2019 [@the_world_bank_data_urban_nodate] to 68% by 2050 [@population_division_united_nations_world_2019], thus a growth of ecosystem services in cities would ensue. 
The relation between demand and supply of ecosystem services varies with scale. 
Locally generated ecosystem services are more closely related to the living quality of the resident and some of them is irreplaceable by other distant sources (for example, mitigation of heat island effect) [@gomez-baggethun_urban_2013]<!-- 问题：作者观点，列举了ES供需的不同尺度分类 -->. 
And considering the numerous population size in cities, the social and economic value of ecosystem services within cities can be surprisingly high [@gomez-baggethun_classifying_2013]<!-- 问题：作者论点而已 -->. 
Besides, a recent global assessment highlighted how massive urbanization is impacting biodiversity and ecosystems around the world negatively [@elmqvist_urbanization_2013]<!-- [#ori [@elmqvist_urbanization_2013] from [@yi_impacts_2017]]. -->.
Therefore, an improvement of urban ecosystem services could potentially benefit city residents and mitigate global change.

<!-- ES research and practice -->
<!-- A lack of urban ecosystem services in Japan and local model vs. general model in i-tree -->
<!-- 作者观点：相比其他系统，城市ES研究少 -->
Yet compared to other ecosystems, the research for urban ecosystem services is relatively modest [@gomez-baggethun_urban_2013], <!-- haase review统计了UES研究的地理分布 -->
and most of the urban ecosystem services studies, as well as the implementation of the research findings into land use policy, are in North America, Europe, and China [@haase_quantitative_2014; @dobbs_urban_2019].
<!-- 举例：欧美城市ES研究 -->For example, Kremer et al. estimated ecosystem services in New York City with a fine resolution method, considering land use, soil distribution, and population distribution [@kremer_value_2016]. 
Larondelle and Lauf mapped ecosystem services demand and supply at the scale of block in Berlin [@larondelle_balancing_2016].
<!-- 日本的研究情况 -->
While urban ecosystem services research in Japan has been less addressed. 
A pilot study of Japan city evaluated the ecosystem services of street trees in Kawasaki City of Japan using i-Tree [@hirabayashi_estimating_2016]. 
A similar approach was applied to estimate the energy conservation and health benefit of air pollution removal of street trees in Kyoto City [@hirabayashi_customization_2019; @tan_estimation_2021], and monetary value of street trees in Suita City [@kawaguchi_estimation_2021]. 

<!-- gaps of method -->
Ecosystem services are estimated with a sequence of methods, including indicators and valuation.
<!-- indicator method -->
With the former, indicators are used to quantify the state and change of the objects of interest. 
Some of the commonly used indicators are crop yield for food production, carbon storage and carbon sequestration for climate change mitigation, and runoff reduction for hydrological regulation. 
<!-- valuation -->Regarding the latter, two methods were applied to estimate ecosystem services monetary value. 
<!-- first hand -->
One is traditional economic method using firsthand data, including stated preference method and revealed preference method. 
Though the empirical, field-based method can provide more accurate results [@zhao_assessing_2018], it is time consuming and limited on scale. 
<!-- benefit transfer -->
Therefore, the other method, value transfer (or 'benefit transfer') is widely used in ecosystem evaluation [@kremer_key_2016], for which the monetary value estimation of one location (the 'reference ecosystem') is transferred to another (the 'target location') [@costanza_twenty_2017].
<!-- 城市ES计算常用方法和问题 -->
Value transfer method is frequently applied in regional services estimation based on the area of land use/land cover and per unite area ecosystem service value. 
In these studies, urban ecosystem is categorized as ‘urban area’ or ‘built-up area’, and the ecosystem service of the category is estimated with a constant per unit area ecosystem service value.
Particularly, the per unit area ecosystem service value for urban ecosystem from Costanza et al. [@costanza_changes_2014] has been widely applied. 
For instance, the value was used in the study of San Antonio River Basin of Texas [@yi_impacts_2017] and Nigeria [@arowolo_assessing_2018]. 
And some other research modify the value based on local context [@xie_ecological_2003; @xie_expert_2008; @bryan_land-use_2018]. 
However, the land use/land cover based value transfer method could cause uncertainty in urban ecosystem service estimation that it ignores the high heterogeneity in cities and rapid change of land use/land cover and management intensity [@haase_quantitative_2014; @kremer_key_2016]<!-- haase提到原因和农田增收的例子，kremer基于会议专家观点 -->.
To get a more specific per unit area ecosystem service value for urban ecosystem, within-city research and inter-city comparison research are needed. 

<!-- ES provider -->
<!-- 放眼整个城市而非只是大片绿地和行道树 -->
Among the service providers in urban ecosystem (e.g., forest patches, waterways and lakes, parks, brownfields, urban agriculture [@haase_quantitative_2014; @kim_assessing_2015; @haase_shrinking_2013]), urban forest is one of the foremost. 
As a crucial local ecosystem services provider in cities, urban forest functions in many services like carbon storage and sequestration, noise reduction, air quality improvement, energy conservation, and recreation [@bolund_ecosystem_1999; @gomez-baggethun_urban_2013]. 
However, the ecosystem services of urban forest might have been underestimated since many previous research focuse on remnant forest or street trees (e.g., [@tang_carbon_2016; @szkop_evaluation_2016<!-- szkop调查一个大花园 -->]), partially due to data availability. 
While the dispersed green spaces such as private gardens have been less studied, despite the importance of them to urban ecosystem services has been proved [@camps-calvet_ecosystem_2016;@kim_assessing_2015; @haase_shrinking_2013].

<!-- 关于i-tree及其局限性 -->
To estimate the ecosystem services of urban forest more precisely, i-Tree Eco has been applied worldwide in more than one hundred countries<!-- 问题：need ref -->. 
Developed by United States Department of Agriculture, i-Tree Eco allows users to calculate several ecosystem services (carbon storage and sequestration, pollutants removal, runoff reduction, etc.) of each tree with field investigation data of tree species, size, and condition. 
Though i-Tree Eco enhance users to manage urban forest more accurately, even at a single-tree level, one limitations is that being guided by the automatically generated report of the tool, most research using i-Tree Eco only presented the results of inferred total ecosystem services of the whole research area (e.g., see @nowak_urban_2016) or results by species [@kiss_role_2015; @ning_modeling_2016]. 
These results, however, provide little information on the link between within-city heterogeneity and urban ecosystem services. 
Only a few research reported ecosystem services across land use/land cover within cities [@baro_contribution_2014<!-- 巴塞罗那研究，对比了各种土地全市碳吸收和VOC释放总量及单位面积量 -->; @kim_assessing_2015 <!-- 弗吉尼亚空地 -->]. 

<!-- 本文目标和内容 -->
Land classification represents the heterogeneity of a city, driving by both socio-economic and bio-physical factors, and in return, shaping socio-economic and bio-physical environment of a city [@briassoulis_analysis_2019]. 
The main objective of this article is to link land classification and ecosystem services within urban ecosystem, taking Kyoto City as a case study. 
To achieve that goal, a pre-stratified sampling method based on the area of land use classes was applied for field data collection, then i-Tree Eco tool was used to calculate the urban forest structure, tree compensatory value, and ecosystem services. 
The ecosystem services, including carbon storage and sequestration, air pollutants removal, and runoff reduction, were estimated for each tree and further grouped by quadrat. 
We compared ecosystem services at both quadrat level and single-tree level across land classification types. 
And for a better understanding of the link between heterogeneity and ecosystem service pattern, we compared the results of Kyoto City with research of other cities. 

# Method {-}
## Study area {-}
Kyoto City (35°19′16″N-34°52′30″N, 135°33′33″E-135°52′43″E), the capital of Kyoto Prefecture, is located in Kyoto Basin of Kansai region, Honshu island, Japan, with an area of 828 square kilometers. 
The city is dominated by a humid subtropical climate with hot, humid summers, and cold, dry winters. 
It is one of 'Cities designated by government ordinance of Japan' with a population of 1.47 million (0.73 million households) in 2019. 
The area of the built-up area of the city is 144 square kilometers. 

## Tree data collection {-}

<!-- sampling -->
For field investigation, 200 quadrats (20m × 20m) were established, including the alternative ones, by stratified sampling method based on the area of the land use classes [@nowak_ground-based_2008]. 
According to the urban planning system and City Planning Law of Japan, urban land use is categorized into 12 classes, with a regulation on the architectural form and use of the buildings constructed. 
We aggregated them into 6 classes: *Com* (Commercial zone), *ComNeigh* (Neighborhood commercial zone), *Ind* (Industrial zone), *ResOther* (Other residential zone), *ResHigh* (mid/high-rise residential zone), and *ResLow* (Low-rise residential zone). 
The commercial area of Kyoto City is mainly located in the city center, and industrial area in the west and south. 
The field investigation was conducted between May and August in 2019. 
The number of the quadrats investigated (n = 175) of each land use class is shown in Figure \@ref(fig:Map) and Table \@ref(tab:SampleStratify). 

```{r Map, results='markup',fig.cap="Land use of Kyoto City and distribution of quadrats"}
knitr::include_graphics("Manuscript/Map.png")
```

```{r SampleStratify, results="markup"}
library(tidyr)
md_landcover <- info_abb_land_cover[,"land_cover"]
md_tab_sample_stra <- read.csv("In_plot_land_use.csv") %>% 
  subset(Level == "class") %>% 
  select(Landuse_class, Area_ha, Area_prop, Qua_tree) %>% 
  # change order of land use classes
  mutate(Landuse_class = factor(
    Landuse_class, 
    levels = c("Com", "Com neigh", "Ind", "R other", "R high", "R low"))) %>% 
  arrange(Landuse_class) %>% 
  # change column names
  rename("Land use class" = Landuse_class, 
         "Area (ha)" = Area_ha, 
         "Proportion of area" = Area_prop, 
         "Number of quadrats" = Qua_tree) %>% 
  # rename land use
  mutate(`Land use class` = c("Com", "ComNeigh", "Ind", "ResOther", "ResHigh", "ResLow"))
knitr::kable(md_tab_sample_stra, digits = 2, 
             caption = "Sample quadrats by stritied sampling method in this research")
```

<!-- Data collection -->
Following i-Tree Eco workbook [@i-tee_i-tree_2019], the information of the quadrats and trees was collected. 
For each quadrat, we took photos of the surrounding environment and the vegetation, and recorded the type of onsite land cover. 
The 'onsite land cover' is not sub-classification of land use, but the 'actual' land cover of a quadrat.
The types of onsite land cover classes in this research is a combination of default land cover options in i-Tree Eco tool and user-defined ones, including: 
*ComInd* (large commercial building & industrial building), *ComNeiBld* (neighborhood commercial building), *Trans* (transportation), *Insti* (institution), *MulFamiRes* (multi-family residential area), *LowResBld* (low-rise residential building), *Park*, *TemShr* (temple and shrine), *Golf*, *Vacant*, *Water*, *Agri* (agriculture), and *Cemetery*. 
Information of each tree in a quadrat, including species, height, diameter at breast height (DBH), canopy missing percentage, crown size, crown health condition, and crown light exposure, were collected.
A total of 1400 trees (of 141 species) was recorded in the 175 quadrats. 

## Calculation of ecosystem services and tree value {-}

i-Tree model has been widely used to help managers and researchers to quantify urban forest structure, ecosystem services, and tree value. 
<!-- 树的价值由三部分构成 -->
We calculated three values of each tree: compensatory value, representing compensation for the loss of a tree [@nowak_compensatory_2002]; monetary value of carbon storage, representing the cumulative result of net carbon sequestration for years; annual ecosystem services, including carbon sequestration, air pollutants removal, and runoff reduction. 
The ecosystem services of each tree (hereafter, 'single-tree ecosystem services') were then grouped by quadrat and add up to calculate the ecosystem services of a quadrat (hereafter, 'quadrat ecosystem services'). 
We will briefly introduce the method for structure and ecosystem services calculation, and valuation of tree value in the following sections; for more details refer to i-Tree method documentation [@nowak_understanding_2020]. 
To improve the accuracy of results, a modified i-Tree model with local parameters of Kyoto City was applied (see [@tan_estimation_2021] for model details and parameters list). 

**Compensatory value** 
Compensatory value of trees is estimated using the guideline of Council of Tree and Landscape Appraisers [@council_of_tree_and_landscape_appraisers_guide_1992] in i-Tree Eco [@nowak_understanding_2020]. 
Compensatory value of a tree is determined by replacement cost, DBH, and a location-specific per unit trunk area cost. For palm trees, the cost to clear trunk is also considered. 
The values of the these parameters have been compiled for numerous stats in the US; while fo toher countries, an average value of repalcement cost and per unit trunk area cost is applied. 

**Structure index** 
Leaf area is estimated based on species, total height, crown base height, crow width and percent crown missing. 
Leaf biomass is calculated based on leaf area with species-specific convert factor. 
Total biomass for each tree is calculated using species_specific allometric equations from the literature with DBH and total height. 

**Carbon storage and carbon sequestration** 
Carbon storage is estimated based on biomass and carbon content. 
For evergreen and palm species, leaf biomass is added. 
And carbon sequestration is estimated based on growth rate, which is also calculated with the parameters mentioned above and growth adjustment factor of crown health and crown light exposure. 
i-Tree Eco’s default value for carbon is 188 dollars per ton carbon, while the social cost for carbon in Japan is 10,600 Yen (about 96 dollar) per ton from Japanese government document [@ministry_of_the_environment_government_of_japan_manual_2019<!-- page 22 -->]. 
Considering results comparability with other research, we used 188 dollars per ton carbon in our customized i-Tree Eco. 

**Air pollution removal and health benefit** 
Air pollution removal is estimated using percent tree cover and leaf area index. 
The pollutants estimated include nitrogen dioxide ($NO_2$), ozone ($O_3$), particulate matter less than 2.5 µm ($PM2.5$), and sulfur dioxide ($SO_2$). 
In the locations supported more sufficiently in i-Tree Eco (e.g., cities in the US and Canada), the tree data is merged with local pre-processed weather and air pollution concentration data for the calculation of pollutants removal. 
While in this case, since Kyoto City is not officially supported by default, we input the local weather data from local monitor stations manually. 
The valuation of air pollutants removal is estimated based on the cost reduction of avoided adverse health incidences caused by exposure to $NO_2$, $O_3$, $SO_2$ and $PM2.5$ with BenMAP method developed by the US Environmental Protection Agency, connecting medical records and air quality measurements across the US. 

**Runoff reduction**
Runoff reduction in i-Tree Eco is estimated based on the difference between the runoff with current tree cover and that without trees [@hirabayashi_i-tree_2012]. 
In the simulation, rainfall interception of trees and runoff are calculated mainly by precipitation, leaf area index, and infiltration with a time step of hour. 
The storm water control facilities cost in the US is 2.36 US dollars per $m^3$ while that estimation of Suita City, Japan is 719 yen per $m^3$. 
To achieve a better results comparability with other research, the former was applied in our research for the valuation of runoff reduction. 

## Data analysis {-}

The distribution of DBH across land use classes were illustrated for a outline of the the age structure of the trees in the city. 
Then for quadrat ecosystem services, one-way analysis of variance (ANOVA) was used to analyze the differences among land use classes. 
For ecosystem at single-tree level, ANOVA was used to analyze the differences among land use classes and onsite land cover classes respectively. 
For the statistical group comparison where significant difference is deteceted, the Tukey's HSD is applied for a post hoc pairwise comparison [@hazra_biostatistics_2016]. 
Further more, interaction effect of land use and onsite land cover on single-tree ecosystem services was tested by ANOVA. 

```{r TarSpecies}
md_species_landuse <- func_var_sub(inddata, "species", "land_use", 3, 4) %>% 
  .$species %>% unique()
md_species_landcover <- func_var_sub(inddata, "species", "land_cover", 3, 4) %>% 
  .$species %>% unique()
```

Finally, a species-specific analysis was used to compare the single-tree ecosystem services across land classification by species. 
To achieve a robust result, only widespread species presenting across a sequence of land use classes or onsite land cover classes with at least 3 individuals for each land classification are analyzed. 
The target species widespread land use classes include `r knitr::combine_words(md_species_landuse)`, and those widespread onsite land cover include `r knitr::combine_words(md_species_landcover)`.
For each target species, ANOVA and Tukey's HSD were applied to compare single-tree ecosystem services across land use and onsite land cover classes. 

All the analysis was conducted in R (version 4.0.3), and difference was considered significant as *p*<0.05. 
The $aov$ function was applied for ANOVA test and $TukeyHSD$ function was used for the post hoc comparison. 

# Results {-}

## DBH strcuture {-}

```{r DbhProportion}
md_dbh_str <- inddata %>% 
  group_by(land_use) %>% 
  summarise("n(00,15]" = sum(dbh_class == "(00,05]"), 
            "n(15,30]" = sum(dbh_class == "(15,20]"), 
            "n(30,  )" = sum(dbh_class == "(30,  )")) %>% 
  ungroup() %>% 
  left_join(summarise(group_by(inddata, land_use), num_ind = n()), 
            by = "land_use")
md_dbh_str <- cbind(md_dbh_str$land_use, 
  round(md_dbh_str[, grep("n\\(", colnames(md_dbh_str))]/md_dbh_str$num_ind, 2))
```

From the perspective of land use, younger trees with DBH $\le$ 15 cm account for a large proportion across the land use classes (`r range(md_dbh_str$"n(00,15]")[1]*100`% to `r range(md_dbh_str$"n(00,15]")[2]*100`%). 
Industrial zone has more mature trees with DBH > 15 cm than others (Figure \@ref(fig:DBH)), probably reflecting the low manage intensity of Industrial zone. 
And probably constrained by both planting goals and limited space, Neighborhood commercial zone is characterized with larger proportion of younger trees with DBH $\le$ 15 cm. 
From the perspective of onsite land cover, the variance is larger that large commercial building & industrial building and agriculture area have extremely higher proportion of younger trees with DBH $\le$ 30 cm, followed by transportation and park. While institute and cemetery have higher proportion of mature trees with DBH > 30 cm. 

```{r DBH, fig.cap="DBH structure across land use and onsite land cover classes"}
plot_dbh_labels <- c(land_use = "Land use", land_cover = "Land cover")
inddata[c("land_use", "land_cover", "dbh_class")] %>% 
  pivot_longer(cols = c("land_use", "land_cover"), 
               names_to = "use_cover", values_to = "land_class") %>% 
  mutate(use_cover = factor(use_cover, levels = c("land_use", "land_cover"))) %>%
  ggplot() + 
  geom_bar(aes(land_class, fill = dbh_class), position = "fill") + 
  labs(x = "", y = "Proportion", fill = "DBH class") +
  facet_grid(. ~ use_cover, scales = "free_x", space = "free_x", 
             labeller = labeller(use_cover = plot_dbh_label)) + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90))
```

## Tree value {-}

The sum and average number of quadrat annual ecosystem service values, carbon storage value, and compensatory value were calculated (Table \@ref(tab:Valuation)). 
The annual ecosystem service value is 30% as much as carbon storage value. 
While the compensatory value of trees is 121 times of annual ecosystem services. 

```{r Valuation, results="markup"}
quadata %>% 
  select(land_use, compensatory_value, carbon_storage_value, es_annual_value) %>% 
  pivot_longer(cols = c(compensatory_value, carbon_storage_value, es_annual_value), 
               names_to = "Item", values_to = "value") %>% 
  group_by(Item) %>% 
  summarise("Sum" = sum(value), "Quadrat average" = mean(value)) %>% 
  ungroup() %>% 
  arrange(Sum) %>% 
  mutate(Item = 
           c("Annual ecosystem services", "Carbon storage", "Compesatory value")) %>% 
  knitr::kable(
    caption = "Valuation of ecosystem services and compensatory value (unit: dollars)", 
    digits = 0, format.args = list(big.mark = ","))
```

Regarding the composition of annual ecosystem service values (Figure \@ref(fig:AnualEcosystemServices)), $PM_2.5$ removal value account for about half of the total value, followed by $O_3$ removal, carbon sequestration, and runoff reduction value. While $NO_2$ removal and $SO_2$ removal values only account for a small fraction of the total annual ecosystem service value. 

```{r AnualEcosystemServices, fig.cap="Valuation of quadrat ecosystem services across land use classes"}
ggplot(quavalue_summary, aes(land_use, es_value)) + 
  geom_bar(aes(fill = es), stat = "identity", position = "stack") + 
  scale_fill_discrete(
    limits = c("carbon_seq_value", "no2_value", 
               "o3_value", "pm25_value", 
               "so2_value", "avo_runoff_value"), 
    labels = c("Carbon sequestration", "NO2 removal", 
               "O3 removal", "PM2.5 removal", 
               "SO2 removal", "Runoff reduction")) + 
  labs(x = "Land use", y = "Quadrat ecosystem service values (dollars / year)", 
       fill = "Ecosystem service") + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90))
```

But it should be noted that, though ecosystem services valuation can be used for inter-ecosystem-services comparison, the monetary value varies with valuation method. 
Thus researchers should pay attention to indicators of ecosystem services as well, rather than focusing on valuation only. 
<!-- 问题：参考文献有没有 -->

## Quadrat ecosystem services across land use {-}
No significant difference was found for quadrat ecosystem services across land use classes (Figure \@ref(fig:ESsMeanSe)(a)). 

```{r ESsMeanSe, fig.cap="Comparison of ecosystem services across land classes: (a) quadrat ecosystem services across land use classes; (b) single-tree ecosystem services across land use classes; (c) single-tree ecosystem services across onsite land cover classes. The units for the ecosystem services are: kg for carbon sequestration, g for air pollutants removal, m3 for runoff reduction."}
# 分ES类别展示不同土地利用或者土地覆盖下的样方和个体ES均值和标准误
qua_lables <- c(
  carbon_seq = "Carbon \n sequestration",
  no2_removal = "NO2 \n removal",
  o3_removal = "O3 \n removal", 
  pm25_removal = "PM2.5 \n removal", 
  so2_removal = "SO2 \n removal", 
  avo_runoff = "Runoff \n reduction"
)
ind_labels <- c(
  carbon_seq = "Carbon \n sequestration",
  no2_removal = "NO2 \n removal",
  o3_removal = "O3 \n removal", 
  pm25_removal = "PM2.5 \n removal", 
  so2_removal = "SO2 \n removal", 
  avo_runoff = "Runoff \n reduction"
)
# 重排land_cover顺序
inddata_summary[[2]]$land_cover <- 
  factor(inddata_summary[[2]]$land_cover, 
         levels = c("ComInd", "ComNeiBld", "Trans", "Insti", 
                    "MulFamiRes", "LowResBld", "Park", "TemShr", 
                    "Golf", "Vacant", "Water", "Agri", "Cemetery"))
ggarrange(plotlist = list(
  ggarrange(plotlist = list(
    ggplot(quadata_summary, aes(x = land_use, y = mean)) + 
      geom_bar(stat = "identity") + 
      geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.3) + 
      geom_text(aes(x = land_use, y = Inf, label = label), 
                vjust = 0.9, size = 3) + 
      scale_y_continuous(expand = expansion(mult = c(0, 0.3))) + 
      facet_wrap(~ ES, scales = "free_y", nco = 1, strip.position = "left", 
                 labeller = labeller(ES = qua_lables)) + 
      labs(x = "Land use", y = "Quadrat ecosystem services") + 
      theme_bw() +
      theme(axis.text.x = element_text(angle = 90)) + 
      labs(title = "(a)"), 
    ggplot(inddata_summary[[1]], aes(x = land_use, y = mean)) + 
      geom_bar(stat = "identity") + 
      geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.3) + 
      geom_text(aes(x = land_use, y = Inf, label = label), 
                vjust = 0.9, size = 3) + 
      scale_y_continuous(expand = expansion(mult = c(0, 0.3))) + 
      facet_wrap(~ ES, scales = "free_y", ncol = 1, strip.position = "left", 
                 labeller = labeller(ES = ind_labels)) + 
      labs(x = "Land use", y = "Single-tree ecosystem services") +
      theme_bw() + 
      theme(axis.text.x = element_text(angle = 90)) + 
      labs(title = "(b)")
  ), ncol = 2),  
  ggplot(inddata_summary[[2]], aes(x = land_cover, y = mean)) + 
    geom_bar(stat = "identity") + 
    geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.3) + 
    geom_text(aes(x = land_cover, y = Inf, label = label), 
              vjust = 0.9, size = 3) + 
    scale_y_continuous(expand = expansion(mult = c(0, 0.3))) + 
    facet_wrap(~ ES, scales = "free_y", ncol = 1, strip.position = "left", 
               labeller = labeller(ES = ind_labels)) + 
    labs(x = "Onsite land cover", y = "Single-tree ecosystem services") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90)) + 
    labs(title = "(c)") 
), ncol = 2, common.legend = TRUE)
```

## Single-tree ecosystem services across land use and onsite land cover {-}

Different from quadrat ecosystem services, the differences for all the ecosystem services at single-tree level across land use classes (Figure \@ref(fig:ESsMeanSe)(b)) are significant; so are those across onsite land cover classes (Figure \@ref(fig:ESsMeanSe)(c)).
Post hoc comparison for land use indicates that the single-tree carbon sequestration in Industrial zone is higher than that in Other residential zone (*p*<0.05), and higher in Other residential zone than that in Low-rise residential zone (*p*<0.01). 
Trees in Other residential zone have higher air pollutants removal and runoff reduction than those in some other zones like Neighborhood commercial zone, High-rise residential zone, and low-rise residential zone. 
From the perspective of onsite land cover, the trees in vacant area have higher value in annual ecosystem services overall.

The degree of freedom, *F* value and *p* value for test of interaction effects of land use classes and onsite land cover classes for single-tree ecosystem services are presented in Table \@ref(tab:InteractionEffect). 
The interaction effect are significant, as are main effect of land use and main effect of onsite land cover for all the ecosystem services at sing-tree level. 

``` {r InteractionEffect, results="markup", fig.show="hide"}
func_var_sub(inddata, "land_cover", "land_use", 3, 3) %>% 
  func_es_inter(es_annual, "land_use", "land_cover") %>% 
  select(`Ecosystem Service`, Factor, Df, `F value`, `Pr(>F)`) %>% 
  filter(Factor != "Residuals") %>% 
  mutate(Factor = rep(c("land use", "onsite land cover", "interaction"), 6), 
         `Pr(>F)` = case_when(
           `Pr(>F)` < 0.001 ~ "<0.001", 
           `Pr(>F)` < 0.01 ~ "<0.01",
           `Pr(>F)` < 0.05 ~ "<0.05", 
         ), 
         `Ecosystem Service` = case_when(
           `Ecosystem Service` == "carbon_seq" ~ "carbon sequestration", 
           `Ecosystem Service` == "no2_removal" ~ "NO2 removal", 
           `Ecosystem Service` == "o3_removal" ~ "O3 removal", 
           `Ecosystem Service` == "pm25_removal" ~ "PM2.5 removal", 
           `Ecosystem Service` == "so2_removal" ~ "SO2 removal", 
           `Ecosystem Service` == "avo_runoff" ~ "runoff reduction", 
           `Ecosystem Service` == " " ~ ""
         )) %>% 
  knitr::kable(digits = 2, caption = "ANOVA with interaction effects of land use classes and onsite land cover classes on ecosystem services")
```

## Species-specific analysis {-}

The results of species-specific comparison of ecosystem services across land use classes by ANOVA (Table \@ref(tab:SpeLandUse)) indicate that the pattern of single-tree ecosystem services across land use classes could be different for certain species. 
For example, *Acer palmatum* shows significant difference across land use classes in air pollutants removal and runoff reduction while not for carbon sequestration. 
And pattern of comparison of ecosystem services across land use types varies with species. 
For example, the ecosystem services of *Ligustrum lucidum* are higher in Industrial zone than in the others, while ecosystem services of *Acer palmatum* is relative higher in Other Residential zone. 
The results of species-specific comparison of ecosystem services across onsite land cover classes by ANOVA (Table \@ref(tab:SpeLandCover)) also show similar characters. 

```{r SpeLandUse, results="markup"}
# function to get p-value of ESs ~ land class for target species 
mdfunc_spespe <- function(name_tarspe, name_land_class) {
  # subset of inddata of target species
  inddata_tarspe <- 
    inddata[which(inddata$species == name_tarspe), ]
  # data.frame for ANOVA of ESs ~ land class of target species
  pvalue_tar <- 
    sapply(inddata_tarspe[es_annual], 
           function(x){summary(aov(x ~ inddata_tarspe[[name_land_class]], 
                                   data = inddata_tarspe))[[1]]$`Pr(>F)`[1]})
  pvalue_tar <- data.frame(Species = name_tarspe, 
                           "ES" = names(pvalue_tar), 
                           "pvalue" = pvalue_tar)
  rownames(pvalue_tar) <- NULL
  pvalue_tar
}

# p-value of ESs ~ land use for target species 
pvalue_tarspe <- vector("list", length(md_species_landuse))
names(pvalue_tarspe) <- md_species_landuse
for (i in md_species_landuse) {
  pvalue_tarspe[[i]] <- mdfunc_spespe(i, "land_use")
}
pvalue_tarspe <- Reduce(rbind, pvalue_tarspe) %>% 
  mutate(pvalue = round(pvalue, 2)) %>%
  mutate(pvalue = case_when(
    pvalue < 0.001 ~ "<0.001",
    pvalue < 0.01 ~ "<0.01",
    pvalue < 0.05 ~ "<0.05", 
    pvalue >= 0.05 ~ as.character(pvalue)
  )) %>% 
  pivot_wider(names_from = "ES", values_from = "pvalue") %>% 
  rename("Carbon sequestration" = carbon_seq, 
         "NO2 removal" = no2_removal, 
         "O3 removal" = o3_removal, 
         "PM2.5 removal" = pm25_removal, 
         "SO2 removal" = so2_removal, 
         "Runoff reduction" = avo_runoff)
knitr::kable(pvalue_tarspe, digits = 2, caption = "P-value of species-specific comparison of ecosystem services across land use classes by ANOVA")
```

```{r SpeLandCover, results="markup"}
# function to get p-value of ESs ~ land class for target species 
# p-value of ESs ~ onsite land cover for target species 
pvalue_tarspe <- vector("list", length(md_species_landcover))
names(pvalue_tarspe) <- md_species_landcover
for (i in md_species_landcover) {
  pvalue_tarspe[[i]] <- mdfunc_spespe(i, "land_cover")
}
pvalue_tarspe <- Reduce(rbind, pvalue_tarspe) %>% 
  mutate(pvalue = round(pvalue, 2)) %>%
  mutate(pvalue = case_when(
    pvalue < 0.001 ~ "<0.001",
    pvalue < 0.01 ~ "<0.01",
    pvalue < 0.05 ~ "<0.05", 
    pvalue >= 0.05 ~ as.character(pvalue)
  )) %>% 
  pivot_wider(names_from = "ES", values_from = "pvalue") %>% 
  rename("Carbon sequestration" = carbon_seq, 
         "NO2 removal" = no2_removal, 
         "O3 removal" = o3_removal, 
         "PM2.5 removal" = pm25_removal, 
         "SO2 removal" = so2_removal, 
         "Runoff reduction" = avo_runoff)
knitr::kable(pvalue_tarspe, digits = 2, caption = "P-value of species-specific comparison of ecosystem services across onsite land cover classes by ANOVA")
```

# Disscussion {-}

## Comparison of ecosystem services {-}

```{r VirginiaResult}
library(openxlsx)
md_virginia <- read.xlsx(
  xlsxFile = "ODS/Other articles.xlsx", 
  sheet = "kim_assessing_2015", rows = c(1:5))[c(
    "Land.use", "Number.of.treesper.ha", 
    "Carbon.storage.(kg/ha)(SE)", "Carbon.sequestration(kg/yr/ha).(SE)")]
# 更改列名并将单位由kg转化成t
names(md_virginia) <- 
  c("land_use", "num_trees_perha","carbon_storage_tperha","carbon_seq_tperha")
md_virginia[c("carbon_storage_tperha","carbon_seq_tperha")] <- 
  sapply(md_virginia[c("carbon_storage_tperha","carbon_seq_tperha")], 
         function(x){x/1000})
```

```{r SongResult}
# es from song_assessing_2020
data.frame("green_space" = c("Public Park", 
                             "Protective Green Space",
                             "Square Green Space", 
                             "Attached Green Space", 
                             "Study Area"), 
           "per_ha_carbon_seq" = c(4701, 3995.3, 3281, 2937.4, 3472.4)) %>% 
  mutate(per_ha_carbon_seq = per_ha_carbon_seq/1000)
```

To compare our results with other studies, the mean value of carbon storage, carbon sequstration, and runoff reduction by land use classes on a per ha basis were calculated (Table \@ref(tab:EsPerHa)). 
Both carbon storage (11.51-17.41 ton carbon per ha) and annual carbon sequestration (1.35-1.60 ton carbon per ha) of residential zones in this study  are lower than that in Roanoke, Virginia (37.00 and 2.28 ton carbon per ha), while those indexes of Industrial zone of our study (9.95 and 1.19 ton carbon per ha) is higher than that of the latter (7.31 and 0.48 ton carbon per ha) [@kim_assessing_2015]. 
Besides, annual carbon sequestration of residential zones are higher in our research than that of a study for Barcelona, Spain (0.35 and 1.33 ton carbon per ha for high-density and low-density residential area) [@baro_contribution_2014].
The runoff reduction ranges from `r round(min(qua_essperha_lumean$"Runoff reduction (m3/ha/year)"), 2)` to `r round(max(qua_essperha_lumean$"Runoff reduction (m3/ha/year)"), 2)` $m^3/year/ha$, which is similar to a study in green spaces of Luohe, China (24.5-51.1 $m^3/year/ha$) [@song_assessing_2020]. 

```{r EsPerHa, results="markup"}
# 计算部分ES的单位面积效率
qua_essperha_lumean <- lapply(
  quadata[c("carbon_storage", "carbon_seq", "avo_runoff")], 
  # 对每种ES进行计算
  function(x) {
    aggregate(x, by = list(quadata$land_use), function(x) {
      # 计算分土地利用均值并将单位转化为每公顷
      mean(x)/400*10000})}) %>% 
  Reduce(function(x, y) {merge(x, y, by = "Group.1")}, .) %>% 
  rename("Land use" = Group.1, 
         "Carbon storage (ton/ha)" = x.x, 
         "Carbon sequestration (ton/ha/year)" = x.y, 
         "Runoff reduction (m3/ha/year)" = x) %>% 
  # 碳储存和碳吸收结果转化为吨每公顷
  mutate("Carbon storage (ton/ha)" = `Carbon storage (ton/ha)`/1000, 
         "Carbon sequestration (ton/ha/year)" = 
           `Carbon sequestration (ton/ha/year)`/1000)
knitr::kable(qua_essperha_lumean, digits = 2, 
             caption = "Ecosystem services efficiency in Kyoto City")
```

To compare the results of air pollutants removal with other research, we also converted the our results into g per year per square meter tree cover (Table \ref(tab:QuaEssPerTreeCover)). 
The results in Kyoto City is comparable to those of a study in Strasbourg city, France [@selmi_air_2016] ($NO_2$ 0.92 $g/year/m^2$, $O_3$ 3.73 $g/year/m^2$, $PM_2.5$ 0.30 $g/year/m^2$) except for the result of $SO_2$ removal (0.07 $g/year/m^2$). 

```{r QuaEssPerTreeCover, results='markup'}
# 计算部分ES的单位树冠覆盖面积效率
# 逐个样地单位树冠覆盖面积空气净化效率计算结果
qua_esspertreecover_lumean <- as.data.frame(sapply(
  quadata[c("no2_removal", "o3_removal", "pm25_removal", "so2_removal")], 
  function(x) {x/quadata$treecover}))
qua_esspertreecover_lumean <- lapply(
  qua_esspertreecover_lumean[c(
    "no2_removal", "o3_removal", "pm25_removal", "so2_removal")],
  function(x) {
    aggregate(x, by = list(quadata$land_use), mean)})
qua_esspertreecover_lumean <- Reduce(
  function(x, y) {merge(x, y, by = "Group.1")}, qua_esspertreecover_lumean)
names(qua_esspertreecover_lumean) <- 
  c("land_use", "no2_removal", "o3_removal", "pm25_removal", "so2_removal")
# 添加单位
for (i in c("land_use", "no2_removal", "o3_removal", "pm25_removal", "so2_removal")) {
  comment(qua_esspertreecover_lumean[, i]) <- "g/year/m2"
}
qua_esspertreecover_lumean <- qua_esspertreecover_lumean %>% 
  rename("Land use" = land_use, 
         "NO2 removal" = no2_removal, 
         "O3 removal" = o3_removal, 
         "PM2.5 removal" = pm25_removal, 
         "SO2 removal" = so2_removal)
knitr::kable(qua_esspertreecover_lumean, caption = "Mean quadrat air purification efficiency of Kyoto City", digits = 2)
```

Whereas, it should be noted that sampling method may differ among these studies thus confounding the results comparison. 
For instance, the research in Luohe, China focuses on green space rather than random sample quadrats over the city [@song_assessing_2020]; and though also presents the results of quadrat ecosystem services in different land use, the study in Roanoke, Virginia mainly focuses on urban vacant [@kim_assessing_2015]. 
On the other hand, the quadrats with no woody plant are excluded for analysis in these research, which also brings bias to the results comparison. 
The workbook of i-Tree Eco [@i-tee_i-tree_2019] has provided a solid base for standard workflow in field investigation, but the difference mentioned above still highlight the barrier in multi-city study. 

## Carbon storage and sequestration across land use classes {-}

Though not statistically significant, among the 6 land use classes in this research, residential zones have higher average quadrat carbon storage and carbon sequestration than the others. 
<!-- 和其他论文结果对比 -->
A similar pattern was found in Roanoke, Virginia that per hectare carbon storage and annual carbon sequestration in residential area is higher than that in commercial area and industrial area [@kim_assessing_2015]. 
A potential reason is that residential zones tend to have more trees or higher leaf area index than the other land use classes do. 

<!-- 局限：土地利用分类的差异 -->
A limitation of the comparison should be addressed that the concept of land use could varies among the research. 
Land use represents the actual practice and intended use of economical and cultural activities of certain place, which is drived by both bio-physical and socio-economic factors [@turner_land-use_1995]. 
Land use classification systems are distinguished regarding scale and purpose of their development [@briassoulis_analysis_2019]. 
In our study, 'land use' is a classification under City Planning Law of Japan that describes potential use and limitation of building types of an area of land; while some other classification system may emphasis more on actual use of the land. 


## Impact of scale {-}

An implicit assumption is that ecological processes remains consistent across different extents and grain [@uchida_urban_2021], While the convinient assumption usually fails because of the complexity of ecological systems, especially under the high heterogeneity of urban context [@pickett_dynamic_2017]. 

<!-- 粒度的影响 -->
Ecological pattern varies across scale, so is urban ecosystem service pattern [@pickett_dynamic_2017;@uchida_urban_2021]. 
Grain is one components of scale concept [@wu_concepts_2006]. 
Quadrat and single-tree level represent different grain in our study. 
No significant difference was found among quadrat ecosystem services across land use classes, while variance were detected single-tree level for all the ecosystem services (Figure \@ref(fig:ESsMeanSe)(a) and (b)). 
This results support the theoretical conclusion that variance between sample quadrats generally decreases with the increasing of quadrat grain [@wiens_spatial_1989]. 
The results probably indicate that the variance of ecosystem services at single-tree scale is "averaged" at quadrat scale. 

<!-- 不同尺度因素的影响 -->
Urban ecosystem service estimation is also influenced by multi-scale factors [@grafius_impact_2016]. 
We also detected the impact of broad-scale factor (land use classes) and fine-scale factor (onsite land cover classes) on single-tree ecosystem services. 
Though significant difference is found for both of the factors, post hoc comparison results reveals that between-group differences are more frequently found for onsite land cover classes.
The results indicate that the variance of single-tree ecosystem services could be detected at finer-scale factor better. 

## Ecosystem service calculation in cities {-}

<!-- 城市内的异质性 -->
In the prevalent land use/land cover based methodology of ecosystem service calculation, per unit value of urban area is usually considered as constant (e.g. see [@yi_impacts_2017; @arowolo_assessing_2018]). 
Though no significant difference is detected for quadrat ecosystem services across land use classes in our research, it could be a result of high heterogeneity of urban ecosystem rather than homogeneity. 
Land use is a rough classification under the context of law and policy in Japan. 
Within a certian land use type, there can be several onsite land cover classes, and quadrat ecosystem services of certain land use class could be 'averaged' by this mixture. 
The relationship between land use or land cover and ecosystem services requires further research based on high resolution geographic data and sampling at different scale. 

<!-- 城市间的异质性 -->
Another reason for further enrichment of urban ecosystem services benchmark database is the heterogeneity between cities. 
As the comparison of our results with other studies in the previous section shows, per unit ecosystem services could varies across different cities. 
This comparison indicates that local context must be considered when evaluating urban ecosystem services. 

# Conclusion {-}
The purpose of this study is to demonstrate the link between heterogeneity of city and urban ecosystem services, and the potential contribution of dispersed green to urban ecosystem services. 
This study captured the structure, ecosystem services and tree values of urban forest in Kyoto City. 
For urban structure, Industrial zone has more mature trees than the other land use;  large commercial building & industrial building and agriculture area have extremely higher proportion of younger trees than the other onsite land cover. 
The comparison across land use types show that ecosystem services are different across land use and onsite land cover at single-tree level; though no significant is detected at quadrat level. 
The result also indicate that the comparison varies with scale. 
Though less addressed in previous research, the trees in residential area (specifically, Other residential zone in this study) function better in air pollutants removal and runoff reduction; and surprisingly, trees in Industrial zone perform better in carbon sequestration. 
The result suggest a potential important contribution of dispersed green space (like private yard) to urban ecosystem services. 
For a more comprehensive and precise evaluation of ecosystem services of urban forest, further research considering heterogeneity, scale effect, and varieties of green space type is needed. 

# References {-}

<div id="refs"></div>


